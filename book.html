<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chi tiết sách — SkyBook</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4 py-3 flex items-center gap-4">
    <a href="./" class="flex items-center gap-2 font-semibold text-lg">
      <img src="./assets/logo.svg" class="w-8 h-8" alt="SkyBook logo"> SkyBook
    </a>
    <nav class="ml-auto hidden md:flex gap-6">
      <a href="./" class="hover:text-blue-600">Trang chủ</a>
      <a href="./catalog.html" class="hover:text-blue-600">Danh mục</a>
      <a href="./review.html" class="hover:text-blue-600">Review & Đăng TikTok</a>
      <a href="./checkout.html" class="hover:text-blue-600">Thanh toán</a>
    </nav>
    <div class="ml-auto md:ml-0 flex items-center gap-3">
      <a href="./login.html" id="accountLink" class="inline-flex items-center px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Đăng nhập</a>
      <a href="./checkout.html" class="relative inline-flex items-center px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
        Giỏ hàng
        <span id="cartBadge" class="ml-2 inline-flex items-center justify-center min-w-[1.5rem] h-6 rounded-full bg-white text-blue-700 text-xs px-2">0</span>
      </a>
    </div>
  </div>
</header>

<main class="container mx-auto px-4 pt-10 pb-20">
  <div id="content"></div>
  <section class="mt-10 bg-white rounded-2xl p-6 shadow">
    <h2 class="text-xl font-semibold mb-3">Bình luận</h2>
    <div id="commentList" class="space-y-4"></div>
    <form class="mt-6 grid gap-3" onsubmit="event.preventDefault(); addComment();">
      <textarea id="commentText" rows="3" class="w-full rounded-xl border px-4 py-3" placeholder="Viết cảm nhận của bạn về cuốn sách..."></textarea>
      <button class="w-full md:w-auto px-5 py-3 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Gửi bình luận</button>
    </form>
  </section>
</main>

<footer class="mt-20 border-t bg-white">
  <div class="text-center text-xs text-gray-500 py-8">© 2025 SkyBook. All rights reserved.</div>
</footer>

<script>
function fmt(n){return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(n)}
function getId(){ const u = new URL(location.href); return Number(u.searchParams.get('id')||0); }
async function loadBook(){
  const id = getId();
  const res = await fetch('./products.json'); const items = await res.json();
  const it = items.find(x=>Number(x.id)===id) || items[0];
  const html = `
    <article class="grid md:grid-cols-2 gap-8 bg-white rounded-2xl p-6 shadow">
      <img src="${it.image}" alt="${it.title}" class="w-full rounded-xl object-cover"/>
      <div>
        <h1 class="text-3xl font-bold">${it.title}</h1>
        <p class="text-gray-600 mt-1">Tác giả: ${it.author}</p>
        <p class="text-blue-700 font-semibold mt-3">${fmt(it.price)}</p>
        <div class="mt-6">
          <h3 class="font-semibold mb-2">Giới thiệu</h3>
          <p class="text-sm text-gray-700 leading-7">${it.preview || ''}</p>
        </div>
        <div class="mt-6 flex gap-3">
          <button onclick="addToCart(${id})" class="px-5 py-3 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Thêm vào giỏ</button>
          <a href="./review.html" class="px-5 py-3 rounded-xl bg-gray-900 text-white hover:bg-black">Review & Đăng TikTok</a>
        </div>
      </div>
    </article>`;
  document.getElementById('content').innerHTML = html;
  renderComments(id);
  // set title
  document.title = it.title + " — SkyBook";
}
function addToCart(id){
  fetch('./products.json').then(r=>r.json()).then(items=>{
    const it = items.find(x=>Number(x.id)===id); if(!it) return;
    const cart = JSON.parse(localStorage.getItem('sbCart')||'[]');
    cart.push({id: it.id, title: it.title, author: it.author, price: it.price, image: it.image});
    localStorage.setItem('sbCart', JSON.stringify(cart));
    const badge = document.getElementById('cartBadge'); if(badge) badge.innerText = cart.length;
    alert('Đã thêm vào giỏ');
  })
}
function renderComments(id){
  const key = 'sbComments_'+id;
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  const list = document.getElementById('commentList');
  if(arr.length===0){ list.innerHTML = "<p class='text-sm text-gray-500'>Chưa có bình luận nào — hãy là người đầu tiên!</p>"; return; }
  list.innerHTML = arr.map(c => `
    <div class="p-4 bg-gray-50 rounded-xl">
      <div class="text-sm text-gray-500">${new Date(c.ts).toLocaleString('vi-VN')}</div>
      <div class="mt-1 whitespace-pre-wrap">${c.text.replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</div>
    </div>`).join('');
}
function addComment(){
  const id = getId();
  const key = 'sbComments_'+id;
  const text = document.getElementById('commentText').value.trim();
  if(!text){ alert('Vui lòng nhập bình luận'); return; }
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  arr.unshift({ts: Date.now(), text});
  localStorage.setItem(key, JSON.stringify(arr));
  document.getElementById('commentText').value='';
  renderComments(id);
}
// header state
(function(){
  const badge = document.getElementById('cartBadge');
  const cart = JSON.parse(localStorage.getItem('sbCart')||'[]');
  if(badge) badge.innerText = cart.length;
  const accountLink = document.getElementById('accountLink');
  const user = localStorage.getItem('skybookUser');
  if(accountLink){
    if(user){ accountLink.textContent = user.split('@')[0]; accountLink.href='#'; accountLink.onclick=()=>{ localStorage.removeItem('skybookUser'); location.reload(); }; }
    else { accountLink.textContent='Đăng nhập'; accountLink.href='./login.html'; }
  }
})();
document.addEventListener('DOMContentLoaded', loadBook);
</script>
</body>
</html>
