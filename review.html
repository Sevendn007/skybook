<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>SkyBook – Review & Đăng TikTok</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .book-item.active{background:#eef6ff;border:1px solid #93c5fd}
    .tick{display:none}
    .book-item.active .tick{display:inline}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<header class="bg-white shadow-sm sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-4">
    <a href="./" class="font-semibold text-xl">SkyBook</a>
    <nav class="hidden md:flex gap-6">
      <a href="./" class="hover:text-blue-600">Trang chủ</a>
      <a href="./catalog.html" class="hover:text-blue-600">Danh mục</a>
      <a href="./review.html" class="text-blue-700 font-semibold">Review & Đăng TikTok</a>
      <a href="./checkout.html" class="hover:text-blue-600">Thanh toán</a>
    </nav>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8 grid md:grid-cols-[2fr,1fr] gap-6">
  <section class="bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-bold mb-1">Đăng video review lên TikTok</h1>
    <p class="text-gray-600 mb-6">Chọn sách, tải video MP4 (6–20s), nhập caption và bấm <b>Đăng lên TikTok</b>.</p>

    <!-- Chọn sách + file + caption -->
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Chọn sách</label>
        <input id="bookSearch" type="text" placeholder="Nhập tên sách..." class="w-full rounded-xl border px-3 py-2 mb-2">
        <div id="bookList" class="h-64 overflow-auto border rounded-xl p-2 space-y-2"></div>
        <div class="text-sm text-gray-500 mt-2" id="selectedInfo">Chưa chọn</div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Chọn video review (MP4)</label>
        <input id="fileInput" type="file" accept="video/mp4,video/*" class="w-full rounded-xl border px-3 py-2">
        <p class="text-xs text-gray-500 mt-2">Khuyên dùng 9:16, 6–15s, ≤ ~6MB.</p>

        <div class="mt-4">
          <label class="block text-sm font-medium mb-1">Caption</label>
          <textarea id="caption" rows="3" class="w-full rounded-xl border px-3 py-2"
            placeholder="Cảm nhận nhanh về cuốn sách... #SkyBook #ReviewSach"></textarea>
        </div>
      </div>
    </div>

    <!-- Action -->
    <div class="mt-6">
      <button id="btnTiktok" class="px-5 py-3 rounded-xl bg-black text-white hover:bg-gray-800">
        Đăng lên TikTok
      </button>
      <span id="status" class="ml-3 text-sm align-middle"></span>
    </div>
  </section>

  <aside class="bg-white rounded-2xl shadow p-6">
    <h3 class="text-lg font-semibold mb-3">Gợi ý</h3>
    <ul class="list-disc pl-5 text-sm text-gray-600 space-y-2">
      <li>Chỉ tài khoản trong <b>Sandbox Target Users</b> mới authorize.</li>
      <li>Video dọc 9:16, tối thiểu 720×1280 (khuyên 1080×1920), H.264 + AAC.</li>
      <li>Tối ưu dung lượng ≤ ~6MB để tải nhanh và ổn định.</li>
    </ul>
  </aside>
</main>

<footer class="mt-10 border-t bg-white">
  <div class="max-w-5xl mx-auto px-4 py-6 text-xs text-gray-500">© 2025 SkyBook.</div>
</footer>

<script>
const API_BASE = "https://skybook-api.vercel.app";

// ====== Sách mẫu & hashtag ======
let chosenBook = null;
let allBooks = [
  {id:1,title:"Đắc Nhân Tâm",author:"Dale Carnegie"},
  {id:2,title:"Tuổi Trẻ Đáng Giá Bao Nhiêu",author:"Rosie Nguyễn"},
  {id:3,title:"Nhà Giả Kim",author:"Paulo Coelho"},
  {id:4,title:"Muôn Kiếp Nhân Sinh",author:"Nguyên Phong"},
  {id:5,title:"Totto-chan Bên Cửa Sổ",author:"Tetsuko Kuroyanagi"},
  {id:6,title:"Tư Duy Nhanh Và Chậm",author:"Daniel Kahneman"}
];

function toHash(title){
  return '#'+title.normalize('NFD').replace(/\p{Diacritic}+/gu,'').replace(/[^0-9a-zA-Z]+/g,'');
}

function renderBooks(q=''){
  const list = document.getElementById('bookList');
  const ql = q.trim().toLowerCase();
  const filtered = allBooks.filter(b=>!q || b.title.toLowerCase().includes(ql)).slice(0,80);
  list.innerHTML = filtered.map(b=>`
    <button class="book-item w-full text-left px-3 py-2 rounded-lg border hover:bg-gray-100 flex items-center justify-between"
      data-title="${b.title.replace(/"/g,'&quot;')}" data-author="${(b.author||'').replace(/"/g,'&quot;')}">
      <span><span class="font-medium">${b.title}</span><span class="text-gray-500"> — ${b.author||''}</span></span>
      <span class="tick">✅</span>
    </button>
  `).join('');
  Array.from(list.querySelectorAll('.book-item')).forEach(btn=>{
    btn.onclick = ()=>{
      list.querySelectorAll('.book-item').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      chosenBook = {title: btn.dataset.title, author: btn.dataset.author};
      document.getElementById('selectedInfo').innerHTML =
        `Đã chọn: <b>${chosenBook.title}</b> — ${chosenBook.author}`;
      // auto hashtag theo tên sách
      const cap = document.getElementById('caption');
      const tag = toHash(chosenBook.title);
      if(!new RegExp('(^|\\s)'+tag+'(\\s|$)').test(cap.value||'')){
        cap.value = (cap.value + ' ' + tag).trim();
      }
    };
  });
}
document.getElementById('bookSearch').addEventListener('input', e=>renderBooks(e.target.value));
document.addEventListener('DOMContentLoaded', ()=>renderBooks(''));

// ====== TikTok Auth ======
async function ensureTikTokAuth(){
  let token = localStorage.getItem('tiktok_access_token');
  if(token) return token;
  const scope = 'user.info.basic,video.upload,video.publish';
  const r = await fetch(API_BASE + '/api/auth-url?scope='+encodeURIComponent(scope));
  const j = await r.json();
  if (j.authorize_url) location.href = j.authorize_url;
  return null;
}

// ====== Upload & Publish (chỉ Publish) ======
document.getElementById('btnTiktok').addEventListener('click', async ()=>{
  const statusEl = document.getElementById('status');
  try{
    const token = await ensureTikTokAuth(); if(!token) return;
    const file = document.getElementById('fileInput').files[0];
    const caption = document.getElementById('caption').value || '';
    if(!file){
      statusEl.innerText = 'Vui lòng chọn file video.';
      statusEl.className = 'ml-3 text-sm text-red-600';
      return;
    }

    // Kiểm tra nhanh tỷ lệ dọc (không bắt buộc, chỉ để tránh fail)
    const url = URL.createObjectURL(file);
    const v = document.createElement('video');
    v.preload = 'metadata';
    const ready = new Promise(resolve => v.onloadedmetadata = resolve);
    v.src = url; await ready; URL.revokeObjectURL(url);
    const w = v.videoWidth, h = v.videoHeight, ratio = w/h;
    if (h < 1280 || ratio > 0.62) {
      statusEl.innerText = 'Video nên là dọc 9:16 (≥ 720×1280).';
      statusEl.className = 'ml-3 text-sm text-red-600';
      return;
    }

    const fd = new FormData();
    fd.append('video', file);
    fd.append('caption', caption);

    statusEl.innerText = 'Đang đăng lên TikTok...';
    statusEl.className = 'ml-3 text-sm text-gray-700';

    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), 300000); // 300s
    const resp = await fetch(`${API_BASE}/api/publish-file?mode=publish`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token },
      body: fd,
      signal: ac.signal
    }).finally(()=>clearTimeout(t));

    // Không hiển thị log; chỉ hiện thành công/thất bại
    if (resp.ok) {
      statusEl.innerText = 'Đăng thành công.';
      statusEl.className = 'ml-3 text-sm text-green-700';
    } else {
      statusEl.innerText = 'Đăng thất bại.';
      statusEl.className = 'ml-3 text-sm text-red-600';
    }
  }catch(e){
    statusEl.innerText = 'Đăng thất bại.';
    statusEl.className = 'ml-3 text-sm text-red-600';
  }
});
</script>
</body>
</html>
