<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Đăng video review lên TikTok</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .book-item.active{background:#eef6ff;border:1px solid #93c5fd}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<header class="bg-white shadow-sm sticky top-0 z-50">
  <div class="container mx-auto px-4 py-4 flex items-center">
    <a href="./" class="font-semibold text-xl">SkyBook</a>
    <nav class="ml-6 hidden md:flex gap-6">
      <a href="./" class="hover:text-blue-600">Trang chủ</a>
      <a href="./catalog.html" class="hover:text-blue-600">Danh mục</a>
      <a href="./review.html" class="text-blue-700 font-semibold">Review & Đăng TikTok</a>
      <a href="./checkout.html" class="hover:text-blue-600">Thanh toán</a>
    </nav>
    <div class="ml-auto text-sm text-gray-500">Sandbox Integration</div>
  </div>
</header>

<main class="container mx-auto px-4 py-8 grid md:grid-cols-[2fr,1fr] gap-6">
  <section class="bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-bold mb-1">Đăng video review lên TikTok</h1>
    <p class="text-gray-600 mb-6">Chọn sách, tải video (A) hoặc dùng video mẫu (B), sau đó chọn Publish/Draft và bấm đăng.</p>

    <!-- Step 1 -->
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Chọn sách</label>
        <input id="bookSearch" type="text" placeholder="Nhập tên sách..." class="w-full rounded-xl border px-3 py-2 mb-2">
        <div id="bookList" class="h-64 overflow-auto border rounded-xl p-2 space-y-2"></div>
        <div class="text-sm text-gray-500 mt-2" id="selectedInfo">Chưa chọn</div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Chọn video review</label>
        <input id="fileInput" type="file" accept="video/*" class="w-full rounded-xl border px-3 py-2">
        <div class="text-xs text-gray-500 mt-2">Hoặc chọn video mẫu:</div>
        <select id="sampleSelect" class="w-full rounded-xl border px-3 py-2 mt-1">
          <option value="">-- Không dùng video mẫu --</option>
          <option value="sample_a">Mẫu A — Review ngắn (10s)</option>
          <option value="sample_b">Mẫu B — Review 9:16 (12s)</option>
        </select>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="mt-5">
      <label class="block text-sm font-medium mb-1">Caption gợi ý</label>
      <textarea id="caption" rows="3" class="w-full rounded-xl border px-3 py-2" placeholder="Cảm nhận nhanh về cuốn sách... #SkyBook #ReviewSach"></textarea>
    </div>

    <!-- Step 3 -->
    <div class="mt-5">
      <label class="block text-sm font-medium mb-2">Chế độ đăng</label>
      <div class="flex items-center gap-6">
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="mode" value="publish" checked>
          <span>Đăng trực tiếp (Publish)</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="mode" value="draft">
          <span>Lưu bản nháp (Draft)</span>
        </label>
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-6 flex flex-wrap gap-3">
      <button id="btnTiktok" class="px-5 py-3 rounded-xl bg-black text-white hover:bg-gray-800">Đăng lên TikTok</button>
      <button id="btnFacebook" class="px-5 py-3 rounded-xl bg-blue-700 text-white hover:bg-blue-800">Đăng lên Facebook</button>
      <button id="btnYouTube" class="px-5 py-3 rounded-xl bg-red-600 text-white hover:bg-red-700">Đăng lên YouTube</button>
      <button id="btnX" class="px-5 py-3 rounded-xl bg-gray-900 text-white hover:bg-black">Đăng lên X</button>
    </div>

    <div id="status" class="mt-4 text-sm text-gray-700"></div>
  </section>

  <aside class="bg-white rounded-2xl shadow p-6">
    <h3 class="text-lg font-semibold mb-3">Gợi ý</h3>
    <ul class="list-disc pl-5 text-sm text-gray-600 space-y-2">
      <li>Độ dài 6–15s, tỉ lệ 9:16 hiển thị đẹp.</li>
      <li>Caption: thêm hashtag tên sách, #SkyBook, #ReviewSach.</li>
      <li>Chế độ Publish/Draft tùy nhu cầu; Sandbox nên dùng Draft.</li>
      <li>Chỉ tài khoản nằm trong Sandbox Target Users mới authorize được.</li>
    </ul>
  </aside>
</main>

<footer class="mt-10 border-t bg-white">
  <div class="container mx-auto px-4 py-6 text-xs text-gray-500">© 2025 SkyBook.</div>
</footer>

<script>
const API_BASE = "https://skybook-api.vercel.app";

// --- Book list (lấy từ products.json nếu có; fallback danh sách ngắn) ---
async function fetchBooks(){
  try {
    const r = await fetch('./products.json'); if(!r.ok) throw 0;
    return await r.json();
  } catch {
    return [
      {id:1,title:"Đắc Nhân Tâm",author:"Dale Carnegie"},
      {id:2,title:"Tuổi Trẻ Đáng Giá Bao Nhiêu",author:"Rosie Nguyễn"},
      {id:3,title:"Nhà Giả Kim",author:"Paulo Coelho"},
      {id:4,title:"Muôn Kiếp Nhân Sinh",author:"Nguyên Phong"},
      {id:5,title:"Totto-chan Bên Cửa Sổ",author:"Tetsuko Kuroyanagi"},
      {id:6,title:"Sapiens: Lược sử loài người",author:"Yuval Noah Harari"}
    ];
  }
}

let chosenBook = null, allBooks = [];

function toHash(title){
  return '#'+title.normalize('NFD').replace(/\p{Diacritic}+/gu,'').replace(/[^0-9a-zA-Z]+/g,'');
}
function ensureTag(){
  if(!chosenBook) return;
  const cap = document.getElementById('caption');
  const tag = toHash(chosenBook.title);
  if(!new RegExp('(^|\\s)'+tag+'(\\s|$)').test(cap.value||'')){
    cap.value = (cap.value+' '+tag).trim();
  }
}

function renderBooks(q=''){
  const list = document.getElementById('bookList');
  const ql = q.toLowerCase();
  const filtered = allBooks.filter(i => !q || i.title.toLowerCase().includes(ql)).slice(0,50);
  list.innerHTML = filtered.map(i => `
    <button class="book-item w-full text-left px-3 py-2 rounded-lg flex items-center justify-between hover:bg-gray-100"
      data-title="${i.title.replace(/"/g,'&quot;')}" data-author="${(i.author||'').replace(/"/g,'&quot;')}">
      <span><span class="font-medium">${i.title}</span><span class="text-gray-500"> — ${i.author||''}</span></span>
      <span class="tick hidden">✅</span>
    </button>
  `).join('');
  Array.from(list.querySelectorAll('.book-item')).forEach(btn=>{
    btn.onclick = ()=>{
      Array.from(list.querySelectorAll('.book-item')).forEach(b=>{
        b.classList.remove('active'); b.querySelector('.tick').classList.add('hidden');
      });
      btn.classList.add('active'); btn.querySelector('.tick').classList.remove('hidden');
      chosenBook = {title: btn.dataset.title, author: btn.dataset.author};
      document.getElementById('selectedInfo').innerHTML = `Đã chọn: <b>${chosenBook.title}</b> — ${chosenBook.author}`;
      ensureTag();
    };
  });
}

async function boot(){
  allBooks = await fetchBooks();
  renderBooks('');
  document.getElementById('bookSearch').addEventListener('input', e=>renderBooks(e.target.value));
}
document.addEventListener('DOMContentLoaded', boot);

// --- TikTok real flow (Sandbox) ---
async function ensureTikTokAuth(){
  let token = localStorage.getItem('tiktok_access_token');
  if(token) return token;
  const scope = 'user.info.basic,video.upload,video.publish';
  const r = await fetch(API_BASE + '/api/auth-url?scope='+encodeURIComponent(scope));
  const j = await r.json();
  if(j.authorize_url){ location.href = j.authorize_url; }
  else { document.getElementById('status').innerText = 'Không tạo được authorize_url'; }
  return null;
}

async function realPublish(){
  const token = await ensureTikTokAuth();
  if(!token) return;

  const mode = document.querySelector('input[name="mode"]:checked').value;
  const caption = document.getElementById('caption').value || '';
  const file = document.getElementById('fileInput').files[0];
  const sample = document.getElementById('sampleSelect').value;

  // Demo Sandbox thuận tiện: dùng Pull-from-URL (không upload binary từ trình duyệt)
  let sourceUrl = '';
  if(!file){
    if(sample==='sample_a') sourceUrl = location.origin + '/skybook/media/sample_a.mp4';
    if(sample==='sample_b') sourceUrl = location.origin + '/skybook/media/sample_b.mp4';
  }

  document.getElementById('status').innerText = 'Đang gọi TikTok Sandbox (init → publish)...';

  const resp = await fetch(API_BASE + '/api/publish', {
    method:'POST',
    headers:{
      'Authorization':'Bearer '+localStorage.getItem('tiktok_access_token'),
      'X-Caption': caption,
      'X-Mode': mode,
      'X-Source-Url': sourceUrl
    }
  });
  const data = await resp.json();
  if(resp.ok){
    document.getElementById('status').innerHTML = "✅ Hoàn tất.\n<pre class='text-xs bg-gray-50 p-3 rounded mt-2'>"+JSON.stringify(data,null,2)+"</pre>";
  }else{
    document.getElementById('status').innerHTML = "<span class='text-red-600'>❌ Lỗi</span><pre class='text-xs bg-gray-50 p-3 rounded mt-2'>"+JSON.stringify(data,null,2)+"</pre>";
  }
}

document.getElementById('btnTiktok').addEventListener('click', realPublish);

// Placeholder các nút khác
document.getElementById('btnFacebook').onclick=()=>alert('Sẽ tích hợp sau.');
document.getElementById('btnYouTube').onclick=()=>alert('Sẽ tích hợp sau.');
document.getElementById('btnX').onclick=()=>alert('Sẽ tích hợp sau.');
</script>
</body>
</html>
