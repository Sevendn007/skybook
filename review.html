<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>SkyBook - Review & ÄÄƒng TikTok</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css">
  <style>
    .selected-book { border: 2px solid #000; background:#fffceb; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

<div class="max-w-4xl mx-auto py-10 px-4">

  <h1 class="text-3xl font-bold mb-6">ğŸ“š SkyBook - Review sÃ¡ch & ÄÄƒng TikTok</h1>

  <h2 class="text-xl font-semibold mb-3">1) Chá»n sÃ¡ch</h2>
  <div id="bookList" class="grid grid-cols-3 gap-4"></div>

  <h2 class="text-xl font-semibold mt-6 mb-3">2) Caption gá»£i Ã½</h2>
  <textarea id="caption" class="w-full border rounded p-3" rows="3"></textarea>

  <h2 class="text-xl font-semibold mt-6 mb-3">3) Chá»n video máº«u (Sandbox)</h2>
  <select id="sampleSelect" class="border rounded p-2">
    <option value="sample_a">Video máº«u A</option>
    <option value="sample_b">Video máº«u B</option>
  </select>

  <h2 class="text-xl font-semibold mt-6 mb-3">4) ÄÄƒng lÃªn TikTok (Sandbox)</h2>
  <button id="btnTiktok" class="px-5 py-3 rounded-xl bg-black text-white hover:bg-gray-800">
    ÄÄƒng lÃªn TikTok
  </button>

  <p id="status" class="mt-5 text-sm text-gray-600"></p>

</div>

<script>
const API_BASE = "https://skybook-api.vercel.app";
let chosenBook = null;

const books = [
  { title: "Äáº¯c NhÃ¢n TÃ¢m", author: "Dale Carnegie" },
  { title: "NhÃ  Giáº£ Kim", author: "Paulo Coelho" },
  { title: "Tuá»•i Tráº» ÄÃ¡ng GiÃ¡ Bao NhiÃªu", author: "Rosie Nguyá»…n" },
  { title: "MÃ¬nh NÃ³i GÃ¬ Khi NÃ³i Vá» Háº¡nh PhÃºc", author: "Akira" },
  { title: "MuÃ´n Kiáº¿p NhÃ¢n Sinh", author: "NguyÃªn Phong" },
  { title: "TÆ° Duy Nhanh VÃ  Cháº­m", author: "Daniel Kahneman" }
];

function loadBooks(){
  const box = document.getElementById("bookList");
  box.innerHTML = "";
  books.forEach((b,i)=>{
    const div = document.createElement("div");
    div.className = "p-4 border rounded cursor-pointer bg-white";
    div.innerHTML = `<b>${b.title}</b><br><span class="text-sm">${b.author}</span>`;
    div.onclick = () => selectBook(i, div);
    box.appendChild(div);
  });
}

function selectBook(i, el){
  chosenBook = books[i];
  document.querySelectorAll("#bookList div").forEach(d=>d.classList.remove("selected-book"));
  el.classList.add("selected-book");
  document.getElementById("caption").value = `Review sÃ¡ch "${chosenBook.title}" #${chosenBook.title.replace(/\s+/g,'')}`;
}

async function ensureTikTokAuth(){
  let token = localStorage.getItem("tiktok_access_token");
  if(token) return token;
  const r = await fetch(API_BASE + "/api/auth-url?scope=" + encodeURIComponent("user.info.basic,video.upload,video.publish"));
  const j = await r.json();
  location.href = j.authorize_url;
}

async function realPublish(){
  const token = await ensureTikTokAuth();
  if (!token) return;

  document.getElementById("status").innerText = "â³ Äang gá»­i lÃªn TikTok Sandbox...";

  const caption = document.getElementById("caption").value;
  const sample = document.getElementById("sampleSelect").value;
  let sourceUrl = location.origin + "/skybook/media/" + (sample === "sample_a" ? "sample_a.mp4" : "sample_b.mp4");

  const resp = await fetch(API_BASE + "/api/publish", {
    method:"POST",
    headers:{
      "Authorization":"Bearer " + token,
      "X-Caption": caption,
      "X-Mode":"publish",
      "X-Source-Url": sourceUrl
    }
  });
  const data = await resp.json();
  document.getElementById("status").innerHTML =
    (resp.ok ? "âœ… HoÃ n táº¥t!" : "âŒ Lá»—i") +
    `<pre class="text-xs bg-gray-200 p-3 mt-2 rounded">${JSON.stringify(data,null,2)}</pre>`;
}

document.getElementById("btnTiktok").onclick = realPublish;
document.addEventListener("DOMContentLoaded", loadBooks);
</script>

</body>
</html>
